// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String         @id @default(cuid())
  email            String         @unique
  password         String
  name             String
  role             UserRole       @default(STUDENT)
  isActive         Boolean        @default(false) // Requires admin approval
  initialCapital   Float?         @default(10000000) // Starting with 10 million won (null for ADMIN/TEACHER)
  currentCash      Float?         @default(10000000) // Current cash (null for ADMIN/TEACHER)
  hasSelectedWatchlist Boolean    @default(false) // Whether student has selected watchlist
  lastWatchlistChange DateTime?   // Last time watchlist was changed
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  classId          String?
  class            Class?         @relation(fields: [classId], references: [id])
  teacherClasses   Class[]        @relation("TeacherClasses")
  portfolios       Portfolio[]
  transactions     Transaction[]
  holdings         Holding[]
  notifications    Notification[]
  watchlist        Watchlist[]
  studentProgress  StudentProgress[]

  @@index([email])
  @@index([classId])
  @@index([classId, role]) // 복합 인덱스: 학급별 역할 조회 최적화
}

model Class {
  id               String         @id @default(cuid())
  name             String
  code             String         @unique
  teacherId        String
  startDate        DateTime
  endDate          DateTime?
  isActive         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  teacher          User           @relation("TeacherClasses", fields: [teacherId], references: [id])
  students         User[]
  allowedStocks    AllowedStock[]
  studentProgress  StudentProgress[]

  @@index([code])
  @@index([teacherId])
}

model Stock {
  id               String         @id @default(cuid())
  symbol           String         @unique  // 종목코드 (e.g., "005930")
  name             String                  // 한글 종목명
  nameEn           String?                 // 영문 종목명
  shortName        String?                 // 단축명
  market           String                  // KOSPI, KOSDAQ, NASDAQ, NYSE, OTC
  sector           String?
  currency         String         @default("KRW") // KRW, USD, EUR, JPY, CHF
  region           String         @default("Korea") // Korea, US, Global
  currentPrice     Float          @default(0)
  previousClose    Float          @default(0)
  dayOpen          Float?
  dayHigh          Float?
  dayLow           Float?
  volume           BigInt?
  marketCap        BigInt?
  change           Float          @default(0)  // Price change amount
  changePercent    Float          @default(0)  // Price change percentage
  per              Float?         // Price-to-Earnings Ratio
  eps              Float?         // Earnings Per Share
  isActive         Boolean        @default(true)  // Whether stock is available for trading
  isTracked        Boolean        @default(false) // Whether to track price history
  lastPriceUpdate  DateTime?               // Last time price was updated
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  transactions     Transaction[]
  holdings         Holding[]
  priceHistory     PriceHistory[]
  stockPriceHistory StockPriceHistory[]
  allowedStocks    AllowedStock[]
  watchlist        Watchlist[]
  
  @@index([symbol])
  @@index([isTracked])
  @@index([name])
  @@index([lastPriceUpdate])
}

model Portfolio {
  id               String         @id @default(cuid())
  userId           String
  totalValue       Float
  totalCost        Float
  totalProfitLoss  Float
  totalProfitLossPercent Float
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  user             User           @relation(fields: [userId], references: [id])
  
  @@index([userId])
}

model Transaction {
  id               String         @id @default(cuid())
  userId           String
  stockId          String
  type             TransactionType
  quantity         Int
  price            Float
  totalAmount      Float
  commission       Float          @default(0)
  reason           String?        // Mathematical/Economic reasoning
  createdAt        DateTime       @default(now())

  // Relations
  user             User           @relation(fields: [userId], references: [id])
  stock            Stock          @relation(fields: [stockId], references: [id])
  analysis         TransactionAnalysis?

  @@index([userId])
  @@index([stockId])
  @@index([createdAt])
  @@index([userId, createdAt(sort: Desc)]) // 복합 인덱스: 사용자별 최근 거래 조회 최적화
}

model Holding {
  id               String         @id @default(cuid())
  userId           String
  stockId          String
  quantity         Int
  averagePrice     Float
  totalCost        Float
  currentValue     Float
  profitLoss       Float
  profitLossPercent Float
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  user             User           @relation(fields: [userId], references: [id])
  stock            Stock          @relation(fields: [stockId], references: [id])
  
  @@unique([userId, stockId])
  @@index([userId])
  @@index([stockId])
}

model PriceHistory {
  id               String         @id @default(cuid())
  stockId          String
  date             DateTime
  open             Float
  high             Float
  low              Float
  close            Float
  volume           BigInt
  createdAt        DateTime       @default(now())

  // Relations
  stock            Stock          @relation(fields: [stockId], references: [id])
  
  @@unique([stockId, date])
  @@index([stockId])
  @@index([date])
}

// Minute-level stock price history for tracked stocks
model StockPriceHistory {
  id               String         @id @default(cuid())
  stockId          String
  symbol           String
  currentPrice     Float
  previousClose    Float
  dayOpen          Float
  dayHigh          Float
  dayLow           Float
  volume           BigInt         @default(0)
  change           Float          @default(0)
  changePercent    Float          @default(0)
  timestamp        DateTime       @default(now())
  source           String         @default("mock") // mock, kis, alphaVantage, naver, etc.
  createdAt        DateTime       @default(now())

  // Relations
  stock            Stock          @relation(fields: [stockId], references: [id], onDelete: Cascade)
  
  @@index([symbol, timestamp(sort: Desc)])
  @@index([stockId])
  @@index([timestamp])
}

model Leaderboard {
  id               String         @id @default(cuid())
  userId           String
  classId          String?
  totalReturn      Float
  totalReturnPercent Float
  winRate          Float
  totalTrades      Int
  rank             Int
  period           LeaderboardPeriod
  updatedAt        DateTime       @default(now())

  @@unique([userId, classId, period])
  @@index([classId, period])
  @@index([rank])
}

model Notification {
  id               String         @id @default(cuid())
  userId           String
  type             NotificationType
  title            String
  message          String
  isRead           Boolean        @default(false)
  createdAt        DateTime       @default(now())

  // Relations
  user             User           @relation(fields: [userId], references: [id])
  
  @@index([userId, isRead])
  @@index([createdAt])
}

// Allowed stocks per class - teacher can control which stocks are available
model AllowedStock {
  id               String         @id @default(cuid())
  classId          String
  stockId          String
  isActive         Boolean        @default(true)
  addedBy          String         // Teacher who added this stock
  createdAt        DateTime       @default(now())
  
  // Relations
  class            Class          @relation(fields: [classId], references: [id])
  stock            Stock          @relation(fields: [stockId], references: [id])
  
  @@unique([classId, stockId])
  @@index([classId])
  @@index([stockId])
}

// Student watchlist - max 10 stocks per student, can change once daily
model Watchlist {
  id               String         @id @default(cuid())
  userId           String
  stockId          String
  order            Int            @default(0) // Display order (1-10)
  addedAt          DateTime       @default(now())
  
  // Relations
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  stock            Stock          @relation(fields: [stockId], references: [id], onDelete: Cascade)
  
  @@unique([userId, stockId])
  @@unique([userId, order])
  @@index([userId])
  @@index([stockId])
}

// Enums
enum UserRole {
  GUEST
  STUDENT
  TEACHER
  ADMIN
}

enum TransactionType {
  BUY
  SELL
}

enum LeaderboardPeriod {
  DAILY
  WEEKLY
  MONTHLY
  ALL_TIME
}

enum NotificationType {
  TRADE_EXECUTED
  PRICE_ALERT
  SYSTEM
  ACHIEVEMENT
}

// ============================================
// 교육 기능 강화 모델
// ============================================

// 거래 근거 분석 모델
model TransactionAnalysis {
  id               String         @id @default(cuid())
  transactionId    String         @unique
  userId           String

  // 근거 분석
  reasonLength     Int            @default(0)      // 근거 텍스트 길이
  hasNewsRef       Boolean        @default(false)  // 뉴스 참조 여부
  conceptsMentioned String[]                       // 언급된 경제 개념 ["PER", "분산투자", "모멘텀"]
  qualityScore     Float          @default(0)      // 품질 점수 (1-5)

  // 교사 피드백
  teacherFeedback  String?                         // 교사 코멘트
  feedbackDate     DateTime?                       // 피드백 작성일

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  transaction      Transaction    @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([qualityScore])
}

// 학생 학습 진도 모델
model StudentProgress {
  id               String         @id @default(cuid())
  userId           String
  classId          String

  // 거래 통계
  totalTrades      Int            @default(0)      // 총 거래 횟수
  profitableTrades Int            @default(0)      // 수익 거래 횟수
  winRate          Float          @default(0)      // 승률 (%)
  avgReturn        Float          @default(0)      // 평균 수익률 (%)

  // 학습 지표
  conceptsLearned  String[]                        // 학습한 경제 개념
  riskLevel        String         @default("unknown") // 위험 선호도: low/medium/high
  tradingStyle     String?                         // 투자 스타일: value/growth/momentum

  // 진도
  level            Int            @default(1)      // 레벨 (1-10)
  experience       Int            @default(0)      // 경험치 포인트

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  class            Class          @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([userId, classId])
  @@index([userId])
  @@index([classId])
  @@index([level])
}