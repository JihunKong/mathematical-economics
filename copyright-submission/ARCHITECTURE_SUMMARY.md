# 시스템 아키텍처 요약
## 경제수학 모의주식 투자 교육 플랫폼

---

## 1. 전체 시스템 구조

```
┌─────────────────────────────────────────────────────────────┐
│                    Frontend (React)                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │
│  │ 학생 대시보드 │ │ 교사 관리   │ │    관리자 패널          │ │
│  └─────────────┘ └─────────────┘ └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                        HTTPS/WSS
                              │
┌─────────────────────────────────────────────────────────────┐
│                   Backend (Node.js)                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │
│  │   API       │ │ WebSocket   │ │    Cron Jobs            │ │
│  │   Gateway   │ │   Server    │ │    (Stock Updates)      │ │
│  └─────────────┘ └─────────────┘ └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                     Multiple Data Sources
                              │
┌─────────────────────────────────────────────────────────────┐
│              Stock Data Collection System                   │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │
│  │  KRX API    │ │ Naver Web   │ │   Python Crawlers       │ │
│  │ (Real-time) │ │  Scraping   │ │   (Batch Updates)       │ │
│  └─────────────┘ └─────────────┘ └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                      Data Storage
                              │
┌─────────────────────────────────────────────────────────────┐
│              Database & Cache System                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐ │
│  │ PostgreSQL  │ │    Redis    │ │   File System           │ │
│  │ (Main DB)   │ │   (Cache)   │ │   (JWT Keys, Logs)      │ │
│  └─────────────┘ └─────────────┘ └─────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 핵심 혁신 기술

### 2.1 다중 소스 실시간 주식 데이터 시스템

**우선순위 기반 데이터 수집**:
1. **KRX API** (최우선) - 실시간 데이터, 장중 최고 정확도
2. **네이버 금융** (2순위) - 웹 스크래핑, 안정적 백업
3. **Yahoo Finance** (3순위) - 국제 주식 및 과거 데이터
4. **Mock Service** (최후) - 서비스 연속성 보장

**폴백 메커니즘**:
- 상위 소스 실패 시 자동으로 하위 소스 전환
- 각 소스별 타임아웃 및 재시도 로직
- 캐싱으로 성능 최적화 (60초 TTL)

### 2.2 교육 특화 거래 시스템

**거래 제약 엔진**:
- 모든 매수/매도에 근거 작성 의무 (최소 10자)
- 일일 거래 횟수 제한 (과도한 거래 방지)
- 교사 승인 종목만 거래 가능
- 시장 운영 시간 및 거래일 검증

**학습 분석 기능**:
- 거래 근거 품질 평가
- 투자 성과 패턴 분석
- 리스크 관리 능력 측정
- 수학적 지표 기반 포트폴리오 분석

### 2.3 JWT 키 자동 관리 시스템

**무중단 키 로테이션**:
- 30일마다 자동 키 갱신
- 이전 키와 현재 키 동시 지원 (그레이스 피리어드)
- 파일 시스템 영구 저장으로 서버 재시작 시에도 유지
- 토큰 검증 시 이중 키 확인

**보안 강화**:
- Access Token: 15분 (짧은 만료)
- Refresh Token: 30일 (긴 세션)
- 역할 기반 권한 제어 (RBAC)
- 자동 토큰 갱신 메커니즘

---

## 3. 데이터베이스 설계

### 3.1 핵심 테이블 구조

**사용자 관리**:
- `users` - 사용자 기본 정보 및 역할
- `classes` - 교사별 학급 관리
- `portfolios` - 개인별 포트폴리오

**주식 데이터**:
- `stocks` - 종목 기본 정보
- `stock_price_history` - 분단위 가격 히스토리
- `price_history` - 일단위 과거 데이터

**거래 시스템**:
- `transactions` - 모든 거래 내역
- `holdings` - 현재 보유 종목
- `watchlist` - 관심종목 (학생당 최대 10개)

### 3.2 관계형 설계

**사용자 중심 구조**:
- User → Portfolio (1:N)
- User → Transaction (1:N)
- User → Holding (1:N)

**교육 관리 구조**:
- Teacher → Class (1:N)
- Class → Student (1:N)
- Class → AllowedStock (1:N)

**주식 데이터 구조**:
- Stock → Transaction (1:N)
- Stock → PriceHistory (1:N)
- Stock → Holding (1:N)

---

## 4. API 설계

### 4.1 RESTful API 구조

**인증 API** (`/api/auth`):
- `POST /register` - 사용자 등록
- `POST /login` - 로그인
- `POST /refresh` - 토큰 갱신
- `POST /logout` - 로그아웃

**주식 데이터 API** (`/api/stocks`):
- `GET /{symbol}` - 종목 상세 정보
- `GET /{symbol}/chart` - 차트 데이터
- `GET /search` - 종목 검색

**거래 API** (`/api/trading`):
- `POST /buy` - 주식 매수
- `POST /sell` - 주식 매도
- `GET /history` - 거래 내역

**포트폴리오 API** (`/api/portfolio`):
- `GET /` - 포트폴리오 조회
- `GET /performance` - 성과 분석

### 4.2 WebSocket 실시간 통신

**구독 기반 업데이트**:
- 클라이언트가 관심 종목 구독
- 가격 변동 시 해당 구독자에게만 전송
- 자동 재연결 및 상태 관리

**이벤트 타입**:
- `priceUpdate` - 실시간 가격 업데이트
- `portfolioUpdate` - 포트폴리오 변경
- `notification` - 시스템 알림

---

## 5. 보안 아키텍처

### 5.1 다층 보안 구조

**네트워크 보안**:
- HTTPS/TLS 1.3 암호화 통신
- CORS 정책으로 도메인 제한
- Rate Limiting (일반: 100req/min, 로그인: 5req/15min)

**애플리케이션 보안**:
- JWT 기반 stateless 인증
- 역할 기반 접근 제어 (RBAC)
- 입력 데이터 검증 및 SQL 인젝션 방지

**데이터 보안**:
- 비밀번호 bcrypt 해싱
- 민감 데이터 AES-256 암호화
- 개인정보 접근 로그 기록

### 5.2 모니터링 및 감사

**실시간 모니터링**:
- 시스템 리소스 모니터링
- API 응답 시간 추적
- 에러 발생률 모니터링

**보안 감사**:
- 모든 관리자 작업 로그 기록
- 의심스러운 로그인 시도 탐지
- 대량 거래 패턴 모니터링

---

## 6. 성능 최적화

### 6.1 캐싱 전략

**계층화된 캐싱**:
- L1: 메모리 캐시 (30초, 빠른 접근)
- L2: Redis 캐시 (5분, 분산 캐시)
- L3: 데이터베이스 (영구 저장)

**캐시 무효화**:
- 의존성 기반 무효화
- TTL 기반 자동 만료
- 수동 무효화 API 제공

### 6.2 데이터베이스 최적화

**인덱스 전략**:
- 복합 인덱스로 쿼리 성능 향상
- 부분 인덱스로 저장 공간 최적화
- 쿼리 실행 계획 분석 및 최적화

**배치 처리**:
- 대량 데이터 삽입 시 배치 처리
- 비동기 작업으로 응답 시간 단축
- 커넥션 풀링으로 DB 연결 최적화

---

## 7. 확장성 설계

### 7.1 마이크로서비스 아키텍처

**서비스 분리**:
- 인증 서비스 (JWT, 사용자 관리)
- 주식 데이터 서비스 (가격 수집, 차트)
- 거래 서비스 (매수/매도, 포트폴리오)
- 교육 관리 서비스 (클래스, 분석)

**독립적 확장**:
- 각 서비스별 독립 배포 가능
- 로드밸런싱으로 수평 확장
- 서비스 간 API 통신

### 7.2 컨테이너화 및 오케스트레이션

**Docker 컨테이너화**:
- 환경 일관성 보장
- 빠른 배포 및 롤백
- 리소스 격리 및 효율성

**Kubernetes 준비**:
- 자동 스케일링 설정
- 헬스체크 및 자동 복구
- 설정 관리 및 시크릿 관리

---

이 아키텍처는 **교육용 특수성**과 **엔터프라이즈급 안정성**을 모두 고려한 혁신적인 설계로, 확장 가능하고 유지보수가 용이한 시스템을 제공합니다.